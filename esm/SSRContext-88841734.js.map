{"version":3,"file":"SSRContext-88841734.js","sources":["../src/util/LruCache.js","../src/util/CachedDeliveryApi.ts","../src/util/ContensisDeliveryApi.ts","../src/util/SSRContext.tsx"],"sourcesContent":["class CacheNode {\n  constructor(key, value) {\n    this.key = key;\n    this.value = value;\n    this.next = null;\n    this.prev = null;\n  }\n}\n\nexport class LruCache {\n  constructor(limit = 100) {\n    this.map = {};\n    this.head = null;\n    this.tail = null;\n    this.limit = limit || 100;\n    this.size = 0;\n  }\n\n  get(key) {\n    if (this.map[key]) {\n      let value = this.map[key].value;\n      let node = new CacheNode(key, value);\n      this.remove(key);\n      this.setHead(node);\n      return value;\n    }\n  }\n\n  set(key, value) {\n    let node = new CacheNode(key, value);\n    if (this.map[key]) {\n      this.remove(key);\n    } else {\n      if (this.size >= this.limit) {\n        delete this.map[this.tail.key];\n        this.size--;\n        this.tail = this.tail.prev;\n        this.tail.next = null;\n      }\n    }\n    this.setHead(node);\n  }\n\n  setHead(node) {\n    node.next = this.head;\n    node.prev = null;\n    if (this.head) {\n      this.head.prev = node;\n    }\n    this.head = node;\n    if (!this.tail) {\n      this.tail = node;\n    }\n    this.size++;\n    this.map[node.key] = node;\n  }\n\n  remove(key) {\n    let node = this.map[key];\n    if (!node) return; // This is sometimes null and crashes the container without this check\n\n    if (node.prev) {\n      node.prev.next = node.next;\n    } else {\n      this.head = node.next;\n    }\n    if (node.next) {\n      node.next.prev = node.prev;\n    } else {\n      this.tail = node.prev;\n    }\n    delete this.map[key];\n    this.size--;\n  }\n}\n","import { VersionStatus } from 'contensis-core-api';\nimport { Client, Query } from 'contensis-delivery-api';\nimport {\n  INodeOperations,\n  NodeGetRootOptions,\n} from 'contensis-delivery-api/lib/models';\n\nimport {\n  DeliveryApi,\n  SSRContext,\n  getClientConfig,\n} from './ContensisDeliveryApi';\nimport { LruCache } from './LruCache';\nimport { CookieObject } from '~/user/util/CookieConstants';\n\n// CachedSearch does not cache results in SSR by design\nclass CachedSearch {\n  cache = new LruCache();\n  cookies?: CookieObject;\n  ssr?: SSRContext;\n\n  constructor(ssr?: SSRContext) {\n    this.ssr = ssr;\n    this.cookies = this.ssr?.cookies.raw;\n  }\n\n  getClient(...args: Parameters<DeliveryApi['getClient']>) {\n    return new DeliveryApi(this.ssr).getClient(...args);\n  }\n\n  search(query: Query, linkDepth = 0, project?: string) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project}+${JSON.stringify(query)}+${linkDepth}`,\n      () => client.entries.search(query, linkDepth)\n    );\n  }\n\n  searchUsingPost(query: Query, linkDepth = 0, project = '') {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project}+${JSON.stringify(query)}+${linkDepth}`,\n      () => (client.entries as any).searchUsingPost(query, linkDepth)\n    );\n  }\n\n  get(\n    id: string,\n    linkDepth = 0,\n    versionStatus: VersionStatus = 'published',\n    project?: string\n  ) {\n    const client = Client.create({\n      ...getClientConfig(project, this.ssr),\n      versionStatus,\n    });\n    return this.request(id, () => client.entries.get({ id, linkDepth }));\n  }\n\n  getContentType(id: string, project?: string) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(`[CONTENT TYPE] ${id} ${project}`, () =>\n      client.contentTypes.get(id)\n    );\n  }\n\n  getRootNode(\n    options: NodeGetRootOptions,\n    versionStatus: VersionStatus = 'published',\n    project?: string\n  ) {\n    const client = Client.create({\n      ...getClientConfig(project, this.ssr),\n      versionStatus,\n    });\n    return this.request(`${project} / ${JSON.stringify(options)}`, () =>\n      client.nodes.getRoot(options)\n    );\n  }\n\n  getNode(options: Parameters<INodeOperations['get']>[0], project?: string) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project} ${\n        options && typeof options !== 'string'\n          ? 'path' in options\n            ? options.path\n            : options.id\n          : options\n      } ${JSON.stringify(options)}`,\n      () => client.nodes.get(options)\n    );\n  }\n\n  getAncestors(\n    options: Parameters<INodeOperations['getAncestors']>[0],\n    project?: string\n  ) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project} [A] ${\n        (options && typeof options !== 'string' && options.id) || options\n      } ${JSON.stringify(options)}`,\n      () => client.nodes.getAncestors(options)\n    );\n  }\n\n  getChildren(\n    options: Parameters<INodeOperations['getChildren']>[0],\n    project?: string\n  ) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project} [C] ${\n        (options && typeof options !== 'string' && options.id) || options\n      } ${JSON.stringify(options)}`,\n      () => client.nodes.getChildren(options)\n    );\n  }\n\n  getSiblings(\n    options: Parameters<INodeOperations['getSiblings']>[0],\n    project?: string\n  ) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project} [S] ${\n        (options && typeof options !== 'string' && options.id) || options\n      } ${JSON.stringify(options)}`,\n      () => client.nodes.getSiblings(options)\n    );\n  }\n\n  request<T extends () => Promise<any>>(key: string, execute: T) {\n    // do not cache results in SSR\n    if (!this.cache.get(key) || typeof window == 'undefined') {\n      const promise = execute();\n      this.cache.set(key, promise);\n      promise.catch(() => {\n        this.cache.remove(key);\n      });\n    }\n    return this.cache.get(key) as ReturnType<T>;\n  }\n}\n\nexport const cachedSearch = new CachedSearch();\nexport const cachedSearchWithCookies = (ssr?: SSRContext) =>\n  new CachedSearch(ssr);\n","import { VersionStatus } from 'contensis-core-api';\nimport { Client, Query } from 'contensis-delivery-api';\nimport { Config } from 'contensis-delivery-api/lib/models';\nimport { parse } from 'query-string';\nimport { setSurrogateKeys } from '~/routing/redux/actions';\nimport { reduxStore } from '~/redux/store/store';\nimport {\n  selectCurrentHostname,\n  selectCurrentPath,\n  selectCurrentSearch,\n} from '~/routing/redux/selectors';\nimport { CookieObject, findLoginCookies } from '~/user/util/CookieConstants';\nimport { Request } from 'express';\nimport { IncomingHttpHeaders } from 'http';\nimport { SSRContext as SSRContextType } from '~/models';\n\nexport type SSRContext = Omit<SSRContextType, 'api'>;\n\nconst mapCookieHeader = (cookies: CookieObject | string) =>\n  typeof cookies === 'object'\n    ? Object.entries(cookies)\n        .map(([name, value]) => `${name}=${value}`)\n        .join('; ')\n    : cookies;\n\nconst getSsrReferer = () => {\n  if (typeof window === 'undefined') {\n    const state = reduxStore.getState();\n    const referer = `${selectCurrentHostname(state)}${selectCurrentPath(\n      state\n    )}${selectCurrentSearch(state)}`;\n\n    return referer;\n  }\n  return '';\n};\n\nconst storeSurrogateKeys = (ssr?: SSRContext) => (response: any) => {\n  let keys = '';\n  if (response.status === 200) {\n    keys = response.headers.get\n      ? response.headers.get('surrogate-key')\n      : response.headers.map['surrogate-key'];\n    if (!keys) console.info(`[storeSurrogateKeys] No keys in ${response.url}`);\n  }\n  const put = ssr?.dispatch || reduxStore?.dispatch;\n  put?.(setSurrogateKeys(keys, response.url, response.status));\n};\n\nconst deliveryApiConfig = (ssr?: SSRContext) => {\n  const config: Config = {\n    ...DELIVERY_API_CONFIG /* global DELIVERY_API_CONFIG */,\n  };\n\n  if (typeof window === 'undefined') {\n    config.defaultHeaders = {\n      'x-require-surrogate-key': 'true',\n      'x-crb-ssr': 'true', // add this for support tracing\n    };\n    if (reduxStore) config.defaultHeaders.referer = getSsrReferer();\n\n    config.responseHandler = { [200]: storeSurrogateKeys(ssr) };\n  }\n\n  if (\n    typeof window !== 'undefined' &&\n    PROXY_DELIVERY_API /* global PROXY_DELIVERY_API */\n  ) {\n    // ensure a relative url is used to bypass the need for CORS (separate OPTIONS calls)\n    config.rootUrl = '';\n    config.responseHandler = { [404]: () => null };\n  }\n  return config;\n};\n\nexport const getClientConfig = (project?: string, ssr?: SSRContext) => {\n  const config = deliveryApiConfig(ssr);\n\n  if (project) {\n    config.projectId = project;\n  }\n\n  if (ssr?.cookies) {\n    const cookieHeader = mapCookieHeader(findLoginCookies(ssr.cookies));\n    if (cookieHeader) {\n      config.defaultHeaders = Object.assign(config.defaultHeaders || {}, {\n        Cookie: cookieHeader,\n      });\n    }\n  }\n\n  return config;\n};\n\n// export * from 'contensis-delivery-api';\n\ndeclare let window: Window &\n  typeof globalThis & {\n    versionStatus?: VersionStatus;\n  };\n\nexport class DeliveryApi {\n  cookies?: CookieObject;\n  ssr?: SSRContext;\n\n  constructor(ssr?: SSRContext) {\n    this.ssr = ssr;\n    this.cookies = ssr?.cookies.raw;\n  }\n\n  getClientSideVersionStatus = () => {\n    if (typeof window !== 'undefined') {\n      // Allow overriding versionStatus with the querystring\n      const { versionStatus } = parse(window.location.search);\n      if (versionStatus) return versionStatus;\n      // Client-side we will have a global variable set if rendered by SSR in production\n      if (typeof window.versionStatus !== 'undefined')\n        return window.versionStatus;\n      // For localhost development we can only work out versionStatus from the current hostname\n      const currentHostname = window.location.hostname;\n      return this.getVersionStatusFromHostname(currentHostname);\n    }\n    return null;\n  };\n\n  getServerSideVersionStatus = (request: Request) =>\n    request.query.versionStatus ||\n    deliveryApi.getVersionStatusFromHeaders(request.headers) ||\n    deliveryApi.getVersionStatusFromHostname(request.hostname);\n\n  getVersionStatusFromHeaders = (headers: IncomingHttpHeaders) => {\n    const versionStatusHeader = headers['x-entry-versionstatus'];\n    if (typeof versionStatusHeader !== 'undefined') return versionStatusHeader;\n    return null;\n  };\n\n  getVersionStatusFromHostname = (currentHostname: string) => {\n    if (currentHostname.indexOf('localhost') > -1) return 'latest';\n\n    if (currentHostname.endsWith('contensis.cloud')) {\n      if (currentHostname.indexOf('preview.') > -1) {\n        return 'latest';\n      } else {\n        return 'published';\n      }\n    }\n\n    if (currentHostname.endsWith('cloud.contensis.com')) {\n      if (currentHostname.indexOf('preview-') > -1) {\n        return 'latest';\n      } else {\n        return 'published';\n      }\n    }\n\n    return 'published';\n  };\n\n  search = (query: Query, linkDepth = 0, project?: string) => {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return client.entries.search(\n      query,\n      typeof linkDepth !== 'undefined' ? linkDepth : 1\n    );\n  };\n\n  getClient = (versionStatus: VersionStatus = 'published', project?: string) =>\n    Client.create({\n      ...getClientConfig(project, this.ssr),\n      versionStatus,\n    });\n\n  getEntry = (\n    id: string,\n    linkDepth = 0,\n    versionStatus: VersionStatus = 'published',\n    project?: string\n  ) => {\n    const client = Client.create({\n      ...getClientConfig(project, this.ssr),\n      versionStatus,\n    });\n    return client.entries.get({ id, linkDepth });\n  };\n}\n\nexport const deliveryApi = new DeliveryApi();\n\nexport const deliveryApiWithCookies = (ssr?: SSRContext) =>\n  new DeliveryApi(ssr);\n\nexport * from './CachedDeliveryApi';\n","import { Request, Response } from 'express';\nimport React, {\n  PropsWithChildren,\n  createContext,\n  useContext,\n  useState,\n} from 'react';\nimport { useCookies } from 'react-cookie';\nimport { useDispatch } from 'react-redux';\nimport { SSRContext as SSRContextType } from '~/models';\nimport { cachedSearchWithCookies } from '~/util/CachedDeliveryApi';\nimport { CookieHelper } from '~/user/util/CookieHelper.class';\n\nconst SSRContext = createContext<SSRContextType | null>(null);\n\n/** SSRContextProvider allows us to hold and access request-scoped references\n *  throughout the component tree\n *\n *  adding this in client side allows consumers to write universal code and use\n *  the same helpers and refs as in SSR */\nexport const SSRContextProvider = ({\n  children,\n  request,\n  response,\n}: PropsWithChildren<{ request?: Request; response?: Response }>) => {\n  // In SSR pass references to things in backing sagas\n  // we cannot access in a global scope\n  const dispatch = useDispatch();\n  const cookies = new CookieHelper(...useCookies());\n  const api = cachedSearchWithCookies({ cookies, dispatch });\n\n  const [context] = useState<SSRContextType>({\n    api,\n    cookies,\n    dispatch,\n    request,\n    response,\n  });\n\n  return (\n    <SSRContext.Provider value={{ ...context }}>{children}</SSRContext.Provider>\n  );\n};\n\nexport const useSSRContext = () => useContext(SSRContext) as SSRContextType;\n\nexport const useDeliveryApi = () => {\n  const { api } = useSSRContext();\n  return api;\n};\n"],"names":["CacheNode","constructor","key","value","next","prev","LruCache","limit","map","head","tail","size","get","node","remove","setHead","set","CachedSearch","ssr","_this$ssr","cache","cookies","raw","getClient","args","DeliveryApi","search","query","linkDepth","project","client","Client","create","getClientConfig","request","JSON","stringify","entries","searchUsingPost","id","versionStatus","getContentType","contentTypes","getRootNode","options","nodes","getRoot","getNode","path","getAncestors","getChildren","getSiblings","execute","window","promise","catch","cachedSearch","cachedSearchWithCookies","mapCookieHeader","Object","name","join","getSsrReferer","state","reduxStore","getState","referer","selectCurrentHostname","selectCurrentPath","selectCurrentSearch","storeSurrogateKeys","response","keys","status","headers","console","info","url","put","dispatch","setSurrogateKeys","deliveryApiConfig","config","DELIVERY_API_CONFIG","defaultHeaders","responseHandler","PROXY_DELIVERY_API","rootUrl","projectId","cookieHeader","findLoginCookies","assign","Cookie","getClientSideVersionStatus","parse","location","currentHostname","hostname","getVersionStatusFromHostname","getServerSideVersionStatus","deliveryApi","getVersionStatusFromHeaders","versionStatusHeader","indexOf","endsWith","getEntry","deliveryApiWithCookies","SSRContext","createContext","SSRContextProvider","children","useDispatch","CookieHelper","useCookies","api","context","useState","React","createElement","Provider","useSSRContext","useContext","useDeliveryApi"],"mappings":"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"}